name: run-ql-on-updated-db

on:
  workflow_run:
    workflows: ["build-codeql-db"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  query-all:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted
    timeout-minutes: 0

    env:
      DB_DIR: "/home/runner/app/v8-src-db"
      QL_DIR_SRC: "${{ github.workspace }}/ql"
      QL_DIR_DST: "/home/runner/app/ql"
      OUT_BQRS: "/home/runner/app/bqrs"
      HASH_MARKER: "/home/runner/app/.v8_db_hash"
      CODEQL_RAM: "16384"
      CODEQL_THREADS: "4"
      CODEQL: "/home/runner/codeql/codeql"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show context
        run: |
          echo "Triggered by: $GITHUB_EVENT_NAME"
          whoami
          id
          ls -la "$DB_DIR" || true

      - name: Verify CodeQL binary
        run: |
          test -x "$CODEQL" || { echo "::error::CODEQL not executable at $CODEQL"; exit 1; }
          "$CODEQL" --version

      - name: Verify DB exists
        run: |
          test -d "$DB_DIR" || { echo "::error::DB not found at $DB_DIR"; exit 1; }
          test -f "$DB_DIR/codeql-database.yml" || { echo "::error::Invalid CodeQL DB (missing codeql-database.yml)"; exit 1; }
          
      # 레포의 ql/ → ~/app/ql : 삭제 없이 갱신만 덮어쓰기
      - name: Sync ql/ to /home/runner/app/ql (no delete)
        if: ${{ steps.dbhash.outputs.skip != 'true' }}
        run: |
          if [ ! -d "$QL_DIR_SRC" ]; then
            echo "::error::No ql/ directory in repo at $QL_DIR_SRC"
            exit 1
          fi
          mkdir -p "$QL_DIR_DST"
          rsync -a "$QL_DIR_SRC"/ "$QL_DIR_DST"/
          echo "Synced (no delete):"
          find "$QL_DIR_DST" -maxdepth 2 -type f -name '*.ql' | head -n 50 || true

      # ~/app/ql에 codeql-pack.yml 없으면 생성 후 pack install
      - name: Ensure codeql-pack.yml and install packs
        if: ${{ steps.dbhash.outputs.skip != 'true' }}
        working-directory: ${{ env.QL_DIR_DST }}
        run: |
          if [ ! -f codeql-pack.yml ] && [ ! -f qlpack.yml ]; then
            cat > codeql-pack.yml <<'YAML'
            name: scratch-bug.v8-custom-queries
            version: 0.0.1
            library: false
            extractor: cpp
            dependencies:
              codeql/cpp-all: "*"
            YAML
            echo "Created default codeql-pack.yml"
          fi
          export CODEQL_ALLOW_INSTALLATION_ANYWHERE=true
          "$CODEQL" pack install

      - name: Run all .ql -> .bqrs (skip empty results)
        if: ${{ steps.dbhash.outputs.skip != 'true' }}
        env:
          DB_DIR: "/home/runner/app/v8-src-db"
          QL_DIR: "/home/runner/app/ql"
          OUT_BQRS: "/home/runner/app/bqrs"
          CODEQL: "/home/runner/codeql/codeql"
        run: |
          export CODEQL_ALLOW_INSTALLATION_ANYWHERE=true
          BUNDLED="$CODEQL/bundled/packs"
          SEARCH_PATH="$QL_DIR:$HOME/.codeql/packages:$BUNDLED"

          mkdir -p "$OUT_BQRS"
          shopt -s globstar nullglob
          count_total=0
          count_kept=0
          for q in "$QL_DIR"/**/*.ql; do
            rel="${q#"$QL_DIR"/}"
            out="$OUT_BQRS/${rel%.ql}.bqrs"
            tmp="${out}.tmp"
            mkdir -p "$(dirname "$out")"

            echo "[CodeQL] $rel -> ${out#$OUT_BQRS/} (temp: $(basename "$tmp"))"
            "$CODEQL" query run \
              --database "$DB_DIR" \
              --search-path "$SEARCH_PATH" \
              --output "$tmp" \
              "$q" || { echo "::error::run failed: $rel"; rm -f "$tmp"; exit 1; }

            # 빈 결과면 버린다 (헤더만 있는 경우)
            lines=$("$CODEQL" bqrs decode --format=csv "$tmp" | wc -l | tr -d ' ')
            if [ "${lines:-0}" -le 1 ]; then
              echo "  -> empty result, dropping"
              rm -f "$tmp"
            else
              mv -f "$tmp" "$out"
              echo "  -> non-empty, saved: ${out#$OUT_BQRS/}"
              count_kept=$((count_kept+1))
            fi
            count_total=$((count_total+1))
          done
          echo "Total queries: $count_total, kept(non-empty): $count_kept"

      - name: List BQRS tree
        if: ${{ steps.dbhash.outputs.skip != 'true' }}
        run: |
          find "$OUT_BQRS" -type f -name '*.bqrs' | head -n 200 || true
