name: run-ql-on-updated-db

on:
  workflow_run:
    workflows: ["build-codeql-db"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  query-all:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted
    timeout-minutes: 0

    env:
      DB_DIR: "/home/runner/app/v8-src-db"
      QL_DIR: "/home/runner/app/ql"
      OUT_BQRS: "/home/runner/app/bqrs"
      HASH_MARKER: "/home/runner/app/.v8_db_hash"
      CODEQL_RAM: "16384"
      CODEQL_THREADS: "4"
      # CodeQL 절대경로(환경에 맞게 수정)
      CODEQL: "/home/runner/codeql/codeql"

    steps:
      - name: Show context
        run: |
          echo "Triggered by: $GITHUB_EVENT_NAME"
          whoami
          id
          ls -la "$DB_DIR" || true

      - name: Checkout (optional if ql is not in repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify CodeQL binary
        run: |
          test -x "$CODEQL" || { echo "::error::CODEQL not executable at $CODEQL"; exit 1; }
          "$CODEQL" --version

      - name: Verify DB exists
        run: |
          test -d "$DB_DIR" || { echo "::error::DB not found at $DB_DIR"; exit 1; }
          test -f "$DB_DIR/codeql-database.yml" || { echo "::error::Invalid CodeQL DB (missing codeql-database.yml)"; exit 1; }

      - name: Skip if DB unchanged
        id: dbhash
        run: |
          cur=$(sha256sum "$DB_DIR/codeql-database.yml" | awk '{print $1}')
          echo "current_hash=$cur" >> $GITHUB_OUTPUT
          if [ -f "$HASH_MARKER" ] && [ "$cur" = "$(cat "$HASH_MARKER")" ]; then
            echo "No DB change detected. Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "$cur" > "$HASH_MARKER"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Install packs for ql/
        if: ${{ steps.dbhash.outputs.skip != 'true' }}
        run: |
          if [ -d "$QL_DIR" ]; then
            cd "$QL_DIR"
            if [ -f qlpack.yml ] || [ -f codeql-pack.yml ]; then
              "$CODEQL" pack install
            else
              echo "No qlpack.yml in $QL_DIR — running raw queries."
            fi
          else
            echo "::error::QL_DIR not found: $QL_DIR"
            exit 1
          fi

      - name: Run all .ql -> .bqrs
        if: ${{ steps.dbhash.outputs.skip != 'true' }}
        env:
          DB_DIR: "/home/runner/app/v8-src-db"
          QL_DIR: "/home/runner/app/ql"
          OUT_BQRS: "/home/runner/app/bqrs"
        run: |
          mkdir -p "$OUT_BQRS"
          shopt -s globstar nullglob
          count=0
          for q in "$QL_DIR"/**/*.ql; do
            rel="${q#"$QL_DIR"/}"
            out="$OUT_BQRS/${rel%.ql}.bqrs"
            mkdir -p "$(dirname "$out")"
            echo "[CodeQL] $rel -> ${out#$OUT_BQRS/}"
            "$CODEQL" query run --database "$DB_DIR" --output "$out" "$q"
            count=$((count+1))
          done
          echo "Total queries executed: $count"

      - name: List BQRS tree
        if: ${{ steps.dbhash.outputs.skip != 'true' }}
        run: |
          find "$OUT_BQRS" -type f -name '*.bqrs' | head -n 200 || true
